import { APP_INITIALIZER, InjectionToken, NgModule } from '@angular/core';
import { APOLLO_OPTIONS } from 'apollo-angular';
import { from, InMemoryCache } from '@apollo/client/core';
import { HttpBatchLink, HttpLink } from 'apollo-angular/http';
import { graphQLProviders } from './graphql.providers';
import { cache, createNetworkLink, createRegisterQueryLink, httpUrl, omitTypenameLink } from 'app/config/apollo-client';
import { PubSub } from 'app/core/util/pub-sub';
import { GraphQLCacheService } from './graphql.cache.service';

const sub = new PubSub<string>();

const registerQueryLink = createRegisterQueryLink(sub);

export function createApollo(httpLink: HttpLink): any {
  const networkLink = createNetworkLink(httpLink.create({ uri: httpUrl }));
  return {
    link: from([omitTypenameLink, registerQueryLink, networkLink]),
    cache,
    defaultOptions: {},
  };
}

export const CACHE_TOKEN = new InjectionToken<InMemoryCache>('CACHE');
export const KNOWN_QUERIES_TOKEN = new InjectionToken<PubSub<string>>('KNOWN_QUERIES');

@NgModule({
  providers: [
    {
      provide: APOLLO_OPTIONS,
      useFactory: createApollo,
      deps: [HttpBatchLink],
    },
    {
      provide: CACHE_TOKEN,
      useValue: cache,
    },
    {
      provide: KNOWN_QUERIES_TOKEN,
      useValue: sub,
    },
    {
      provide: APP_INITIALIZER,
      useFactory: (graphQLCacheService: GraphQLCacheService) => () => graphQLCacheService.connect(), deps: [GraphQLCacheService], multi: true
    },
    graphQLProviders,
  ],
})
export class GraphQLModule { }
